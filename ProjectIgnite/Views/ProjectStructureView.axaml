<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ProjectIgnite.ViewModels"
             xmlns:converters="using:ProjectIgnite.Converters"
             xmlns:md="https://github.com/whistyun/Markdown.Avalonia"
             xmlns:ctxt="clr-namespace:ColorTextBlock.Avalonia;assembly=ColorTextBlock.Avalonia"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             d:DataContext="{d:DesignInstance vm:ProjectStructureViewModel}"
             x:Class="ProjectIgnite.Views.ProjectStructureView"
             x:DataType="vm:ProjectStructureViewModel">

  <UserControl.Resources>
    <converters:BooleanNegationConverter x:Key="BooleanNegationConverter" />
  </UserControl.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!-- Header Controls -->
    <Grid Grid.Row="0" Margin="20,20,20,10">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <!-- Project Selection and Actions -->
      <StackPanel Grid.Column="0" Orientation="Vertical" Spacing="15">
        <!-- Project Path Selection -->
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          
          <TextBox Grid.Column="0" 
                   Text="{Binding SelectedProjectPath}" 
                   Watermark="Select a project folder to analyze..."
                   IsReadOnly="True"
                   Height="35" />
          
          <Button Grid.Column="1" 
                  Content="Browse"
                  Command="{Binding BrowseProjectCommand}"
                  Margin="10,0,0,0"
                  Height="35"
                  Width="80" />
        </Grid>

        <!-- Recent Projects Section (updated bindings) -->
        <StackPanel Orientation="Vertical" Margin="0,8,0,0">
          <TextBlock Text="Recent Projects" FontWeight="SemiBold"/>
          <ComboBox
              ItemsSource="{Binding RecentProjects}"
              SelectedItem="{Binding SelectedProject, Mode=TwoWay}"
              MinWidth="240"
              IsEnabled="{Binding HasRecentProjects}">
            <ComboBox.ItemTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding Name}"/>
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>
        </StackPanel>
        

        <!-- Action Buttons -->
        <StackPanel Orientation="Horizontal" Spacing="10">
          <Button Content="Analyze Project"
                  Command="{Binding AnalyzeProjectCommand}"
                  IsEnabled="{Binding IsAnalyzing, Converter={StaticResource BooleanNegationConverter}}"
                  Background="#2196F3"
                  Foreground="White"
                  Height="35"
                  Padding="15,0" />
          
          <Button Content="Regenerate"
                  Command="{Binding RegenerateAnalysisCommand}"
                  IsEnabled="{Binding CanRegenerate}"
                  Background="#FF9800"
                  Foreground="White"
                  Height="35"
                  Padding="15,0" />
          
          <Button Content="Export Mermaid"
                  Command="{Binding ExportMermaidCommand}"
                  IsEnabled="{Binding HasAnalysisResult}"
                  Background="#4CAF50"
                  Foreground="White"
                  Height="35"
                  Padding="15,0" />
          
          <Button Content="Export PNG"
                  Command="{Binding ExportPngCommand}"
                  IsEnabled="{Binding HasAnalysisResult}"
                  Background="#9C27B0"
                  Foreground="White"
                  Height="35"
                  Padding="15,0" />
        </StackPanel>
      </StackPanel>

      <!-- Status Info -->
      <StackPanel Grid.Column="1" 
                  Orientation="Vertical" 
                  HorizontalAlignment="Right"
                  Spacing="5">
        <TextBlock Text="{Binding StatusText}" 
                   HorizontalAlignment="Right"
                   FontSize="12"
                   Foreground="Gray" />
        
        <TextBlock Text="{Binding LastAnalysisTime, StringFormat='Last analysis: {0:MM/dd/yyyy HH:mm}'}" 
                   HorizontalAlignment="Right"
                   FontSize="10"
                   Foreground="Gray"
                   IsVisible="{Binding HasAnalysisResult}" />
      </StackPanel>
    </Grid>

    <!-- Main Content Area -->
    <Grid Grid.Row="1" Margin="20,0,20,10">
      <Grid>
        <!-- Base: Markdown content area -->
        <Border Background="White"
                BorderBrush="#E0E0E0"
                BorderThickness="1"
                CornerRadius="8"
                MinHeight="400"
                IsVisible="{Binding HasAnalysisResult}"
                Padding="20">
          <md:MarkdownScrollViewer Markdown="{Binding MarkdownContent}" >
            <md:MarkdownScrollViewer.MarkdownStyle>
              <Style>
                <Style Selector=".Markdown_Avalonia_MarkdownViewer TextBlock.CodeBlock">
                  <Style.Setters>
                    <Setter Property="Foreground" Value="White" />
                  </Style.Setters>
                </Style>
                <Style Selector=".Markdown_Avalonia_MarkdownViewer ctxt|CCode">
                  <Style.Setters>
                    <Setter Property="Foreground" Value="White" />
                  </Style.Setters>
                </Style>
              </Style>
            </md:MarkdownScrollViewer.MarkdownStyle>
          </md:MarkdownScrollViewer>
        </Border>

        <!-- Empty State Overlay (initial guidance) -->
        <Border IsVisible="{Binding ShowEmptyState}"
                Background="#FAFAFA"
                BorderBrush="#E0E0E0"
                BorderThickness="1"
                CornerRadius="8"
                Padding="50">
          <StackPanel Orientation="Vertical"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      Spacing="20">
            <Path Width="64"
                  Height="64"
                  Fill="#BDBDBD"
                  Data="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14H4A3,3 0 0,1 1,11V5A3,3 0 0,1 4,2H12M12,4H4A1,1 0 0,0 3,5V11A1,1 0 0,0 4,12H12A1,1 0 0,0 13,11V5A1,1 0 0,0 12,4Z" />
            
            <TextBlock Text="No Project Analysis Available"
                       FontSize="18"
                       FontWeight="Medium"
                       Foreground="#757575"
                       HorizontalAlignment="Center" />
            
            <TextBlock Text="Select a project folder and click 'Analyze Project' to generate a structure diagram"
                       FontSize="14"
                       Foreground="#9E9E9E"
                       HorizontalAlignment="Center"
                       TextWrapping="Wrap"
                       MaxWidth="400" />
          </StackPanel>
        </Border>

        <!-- Progress Overlay -->
        <Border IsVisible="{Binding IsAnalyzing}"
                Background="#66000000"
                CornerRadius="8">
          <StackPanel Orientation="Vertical"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      Spacing="20">
            <ProgressBar Value="{Binding ProgressPercentage}"
                         Width="300"
                         Height="6"
                         Background="#E0E0E0"
                         Foreground="#2196F3" />
            
            <TextBlock Text="{Binding ProgressText}"
                       HorizontalAlignment="Center"
                       FontSize="14"
                       Foreground="White" />
            
            <Button Content="Cancel"
                    Command="{Binding CancelAnalysisCommand}"
                    Width="100"
                    Height="30"
                    Background="#F44336"
                    Foreground="White" />
          </StackPanel>
        </Border>

        <!-- Error Overlay -->
        <Border IsVisible="{Binding HasError}"
                Background="#FFEBEE"
                BorderBrush="#F44336"
                BorderThickness="1"
                CornerRadius="8"
                Padding="20">
          <StackPanel Orientation="Vertical" Spacing="15"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
              <Path Width="24" 
                    Height="24" 
                    Fill="#F44336"
                    Data="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z" />
              
              <TextBlock Text="Analysis Error"
                         FontSize="16"
                         FontWeight="Medium"
                         Foreground="#F44336" />
            </StackPanel>
            
            <TextBlock Text="{Binding ErrorMessage}"
                       FontSize="14"
                       Foreground="#D32F2F"
                       TextWrapping="Wrap"
                       TextAlignment="Center"
                       MaxWidth="600" />
            
            <Button Content="Try Again"
                    Command="{Binding AnalyzeProjectCommand}"
                    Width="120"
                    Height="30"
                    Background="#F44336"
                    Foreground="White"
                    HorizontalAlignment="Center" />
          </StackPanel>
        </Border>
      </Grid>
    </Grid>

    <!-- Footer -->
    <Border Grid.Row="2" 
            Background="#F5F5F5"
            BorderBrush="#E0E0E0"
            BorderThickness="0,1,0,0"
            Padding="20,10">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Column="0" 
                    Orientation="Horizontal" 
                    Spacing="20"
                    IsVisible="{Binding HasAnalysisResult}">
          <TextBlock Text="{Binding ProjectType, StringFormat='Project Type: {0}'}"
                     FontSize="12"
                     Foreground="#666" />
          
          <TextBlock Text="{Binding FileCount, StringFormat='Files: {0}'}"
                     FontSize="12"
                     Foreground="#666" />
          
          <TextBlock Text="{Binding DependencyCount, StringFormat='Dependencies: {0}'}"
                     FontSize="12"
                     Foreground="#666" />
        </StackPanel>

        <TextBlock Grid.Column="1"
                   Text="Powered by AI Analysis"
                   FontSize="10"
                   Foreground="#999"
                   VerticalAlignment="Center" />
      </Grid>
    </Border>
  </Grid>
</UserControl>
