<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ProjectIgnite.ViewModels"
             xmlns:converters="using:ProjectIgnite.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="ProjectIgnite.Views.ProjectStructureView"
             x:DataType="vm:ProjectStructureViewModel">

  <Design.DataContext>
    <vm:ProjectStructureViewModel />
  </Design.DataContext>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- æ ‡é¢˜æ  -->
    <Border Grid.Row="0" 
            Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
            BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
            BorderThickness="0,0,0,1"
            Padding="24,16">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!-- æ ‡é¢˜å’Œæè¿° -->
        <StackPanel Grid.Column="0" Orientation="Vertical">
          <TextBlock Text="{Binding Title}"
                     FontSize="20"
                     FontWeight="SemiBold"
                     Margin="0,0,0,4" />
          <TextBlock Text="{Binding Description}"
                     FontSize="14"
                     Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
        </StackPanel>

        <!-- å·¥å…·æ æŒ‰é’® -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
          <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
          <ToggleButton IsChecked="{Binding IsDiagramMode}"
                        Command="{Binding ToggleModeCommand}"
                        ToolTip.Tip="åˆ‡æ¢åˆ°å›¾è¡¨æ¨¡å¼"
                        Classes="mode-toggle">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="{Binding IsDiagramMode, Converter={x:Static converters:BooleanToStringConverter.Instance}, ConverterParameter='ðŸ“Š|ðŸ—ï¸'}" FontSize="16" />
              <TextBlock Text="{Binding IsDiagramMode, Converter={x:Static converters:BooleanToStringConverter.Instance}, ConverterParameter='å›¾è¡¨|ç»“æž„'}" FontSize="12" />
            </StackPanel>
          </ToggleButton>
          
          <!-- ç»“æž„æ¨¡å¼æŒ‰é’® -->
          <StackPanel Orientation="Horizontal" Spacing="4" IsVisible="{Binding !IsDiagramMode}">
            <Button Command="{Binding RefreshCommand}"
                    ToolTip.Tip="åˆ·æ–°é¡¹ç›®ç»“æž„"
                    Classes="toolbar">
              <TextBlock Text="ðŸ”„" FontSize="16" />
            </Button>
            <Button Command="{Binding ExpandAllCommand}"
                    ToolTip.Tip="å±•å¼€æ‰€æœ‰èŠ‚ç‚¹"
                    Classes="toolbar">
              <TextBlock Text="ðŸ“‚" FontSize="16" />
            </Button>
            <Button Command="{Binding CollapseAllCommand}"
                    ToolTip.Tip="æŠ˜å æ‰€æœ‰èŠ‚ç‚¹"
                    Classes="toolbar">
              <TextBlock Text="ðŸ“" FontSize="16" />
            </Button>
          </StackPanel>
          
          <!-- å›¾è¡¨æ¨¡å¼æŒ‰é’® -->
          <StackPanel Orientation="Horizontal" Spacing="4" IsVisible="{Binding IsDiagramMode}">
            <Button Command="{Binding GenerateDiagramCommand}"
                    ToolTip.Tip="ç”Ÿæˆå›¾è¡¨"
                    Classes="toolbar primary"
                    IsEnabled="{Binding !IsGenerating}">
              <TextBlock Text="âœ¨" FontSize="16" />
            </Button>
            <Button Command="{Binding CancelGenerationCommand}"
                    ToolTip.Tip="å–æ¶ˆç”Ÿæˆ"
                    Classes="toolbar"
                    IsVisible="{Binding IsGenerating}">
              <TextBlock Text="â¹ï¸" FontSize="16" />
            </Button>
            <Button Command="{Binding ExportDiagramCommand}"
                    ToolTip.Tip="å¯¼å‡ºå›¾è¡¨"
                    Classes="toolbar"
                    IsEnabled="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}">
              <TextBlock Text="ðŸ’¾" FontSize="16" />
            </Button>
            <Button Command="{Binding ClearDiagramCommand}"
                    ToolTip.Tip="æ¸…é™¤å›¾è¡¨"
                    Classes="toolbar"
                    IsEnabled="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}">
              <TextBlock Text="ðŸ—‘ï¸" FontSize="16" />
            </Button>
          </StackPanel>
        </StackPanel>
      </Grid>
    </Border>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <Grid Grid.Row="1">
      <!-- ç»“æž„æ¨¡å¼ -->
      <Grid IsVisible="{Binding !IsDiagramMode}">
        <!-- åŠ è½½çŠ¶æ€ -->
        <Border IsVisible="{Binding IsLoading}"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                CornerRadius="8"
                Padding="24">
          <StackPanel Orientation="Horizontal" Spacing="12">
            <Border Width="20" Height="20"
                    Background="{DynamicResource SystemControlForegroundAccentBrush}"
                    CornerRadius="10">
              <Border.RenderTransform>
                <RotateTransform />
              </Border.RenderTransform>
              <Border.Styles>
                <Style Selector="Border">
                  <Style.Animations>
                    <Animation Duration="0:0:1" IterationCount="INFINITE">
                      <KeyFrame Cue="0%">
                        <Setter Property="RenderTransform">
                          <RotateTransform Angle="0" />
                        </Setter>
                      </KeyFrame>
                      <KeyFrame Cue="100%">
                        <Setter Property="RenderTransform">
                          <RotateTransform Angle="360" />
                        </Setter>
                      </KeyFrame>
                    </Animation>
                  </Style.Animations>
                </Style>
              </Border.Styles>
            </Border>
            <TextBlock Text="æ­£åœ¨åŠ è½½é¡¹ç›®ç»“æž„..."
                       FontSize="14"
                       VerticalAlignment="Center" />
          </StackPanel>
        </Border>

        <!-- ç©ºçŠ¶æ€ -->
        <Border IsVisible="{Binding !IsLoading}"
                Background="Transparent"
                Padding="24">
          <ScrollViewer>
            <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                    CornerRadius="8"
                    Padding="48"
                    MinHeight="400">
              <StackPanel HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Spacing="16">
                <!-- å›¾æ ‡ -->
                <TextBlock Text="ðŸ—ï¸"
                           FontSize="64"
                           HorizontalAlignment="Center"
                           Opacity="0.6" />
                
                <!-- æ ‡é¢˜ -->
                <TextBlock Text="é¡¹ç›®ç»“æž„"
                           FontSize="24"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,8" />
                
                <!-- æè¿° -->
                <TextBlock Text="{Binding EmptyStateMessage}"
                           FontSize="16"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           HorizontalAlignment="Center"
                           TextWrapping="Wrap"
                           MaxWidth="400"
                           TextAlignment="Center" />
                
                <!-- å ä½å†…å®¹ -->
                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                        CornerRadius="6"
                        Padding="16"
                        Margin="0,16,0,0"
                        MaxWidth="500">
                  <StackPanel Spacing="8">
                    <TextBlock Text="åŠŸèƒ½è§„åˆ’ï¼š"
                               FontWeight="SemiBold"
                               FontSize="14" />
                    <TextBlock Text="â€¢ æ˜¾ç¤ºé¡¹ç›®æ–‡ä»¶æ ‘ç»“æž„"
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="â€¢ æ”¯æŒæ–‡ä»¶å¤¹å±•å¼€/æŠ˜å "
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="â€¢ æ˜¾ç¤ºæ–‡ä»¶ç±»åž‹å’Œå¤§å°ä¿¡æ¯"
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="â€¢ æ”¯æŒæœç´¢å’Œè¿‡æ»¤åŠŸèƒ½"
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                  </StackPanel>
                </Border>
              </StackPanel>
            </Border>
          </ScrollViewer>
        </Border>
      </Grid>

      <!-- å›¾è¡¨æ¨¡å¼ -->
      <Grid IsVisible="{Binding IsDiagramMode}">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="350" />
          <ColumnDefinition Width="4" />
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- å·¦ä¾§æŽ§åˆ¶é¢æ¿ -->
        <Border Grid.Column="0"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="0,0,1,0"
                Padding="16">
          <ScrollViewer>
            <StackPanel Spacing="16">
              <!-- ä»“åº“URLè¾“å…¥ -->
              <StackPanel Spacing="8">
                <TextBlock Text="GitHub ä»“åº“ URL"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <TextBox Text="{Binding RepositoryUrl}"
                         Watermark="https://github.com/owner/repo"
                         Classes="modern" />
              </StackPanel>

              <!-- è‡ªå®šä¹‰æŒ‡ä»¤ -->
              <StackPanel Spacing="8">
                <TextBlock Text="è‡ªå®šä¹‰æŒ‡ä»¤ï¼ˆå¯é€‰ï¼‰"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <TextBox Text="{Binding CustomInstructions}"
                         Watermark="ä¾‹å¦‚ï¼šé‡ç‚¹å…³æ³¨æ•°æ®æµï¼Œå¿½ç•¥æµ‹è¯•æ–‡ä»¶"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MinHeight="80"
                         Classes="modern" />
              </StackPanel>

              <!-- ç”Ÿæˆè¿›åº¦ -->
              <StackPanel Spacing="8" IsVisible="{Binding IsGenerating}">
                <TextBlock Text="ç”Ÿæˆè¿›åº¦"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <ProgressBar Value="{Binding GenerationProgress.Percentage}"
                             Maximum="100"
                             Height="6"
                             CornerRadius="3" />
                <TextBlock Text="{Binding GenerationProgress.Message}"
                           FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
              </StackPanel>

              <!-- ä»“åº“ä¿¡æ¯ -->
              <StackPanel Spacing="8" IsVisible="{Binding RepositoryInfo, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}">
                <TextBlock Text="ä»“åº“ä¿¡æ¯"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                        CornerRadius="6"
                        Padding="12">
                  <StackPanel Spacing="6">
                    <TextBlock Text="{Binding RepositoryInfo.Name}"
                               FontWeight="SemiBold"
                               FontSize="13" />
                    <TextBlock Text="{Binding RepositoryInfo.Description}"
                               FontSize="12"
                               TextWrapping="Wrap"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBlock Text="{Binding RepositoryInfo.Language}"
                                 FontSize="11"
                                 Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                      <TextBlock Text="{Binding RepositoryInfo.StarCount, StringFormat='â­ {0}'}"
                                 FontSize="11"
                                 Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>
                  </StackPanel>
                </Border>
              </StackPanel>

              <!-- å›¾è¡¨æ“ä½œ -->
              <StackPanel Spacing="8" IsVisible="{Binding ShowDiagramControls}">
                <TextBlock Text="å›¾è¡¨æ“ä½œ"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <TextBox Text="{Binding ModificationInstructions}"
                         Watermark="è¾“å…¥ä¿®æ”¹æŒ‡ä»¤..."
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MinHeight="60"
                         Classes="modern" />
                <Button Command="{Binding ModifyDiagramCommand}"
                        Content="ä¿®æ”¹å›¾è¡¨"
                        Classes="modern primary"
                        HorizontalAlignment="Stretch" />
                <Button Command="{Binding CopyDiagramCodeCommand}"
                        Content="å¤åˆ¶ä»£ç "
                        Classes="modern"
                        HorizontalAlignment="Stretch" />
              </StackPanel>
            </StackPanel>
          </ScrollViewer>
        </Border>

        <!-- åˆ†éš”ç¬¦ -->
        <GridSplitter Grid.Column="1"
                      Background="{DynamicResource SystemControlForegroundBaseLowBrush}"
                      ResizeDirection="Columns" />

        <!-- å³ä¾§å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
        <Border Grid.Column="2"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                Padding="16">
          <!-- å›¾è¡¨å†…å®¹ -->
          <Grid>
            <!-- ç©ºçŠ¶æ€ -->
            <Border IsVisible="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}, ConverterParameter=Invert}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
              <StackPanel Spacing="16" HorizontalAlignment="Center">
                <TextBlock Text="ðŸ“Š"
                           FontSize="64"
                           HorizontalAlignment="Center"
                           Opacity="0.6" />
                <TextBlock Text="æž¶æž„å›¾è¡¨"
                           FontSize="24"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Center" />
                <TextBlock Text="è¾“å…¥ GitHub ä»“åº“ URL å¹¶ç‚¹å‡»ç”ŸæˆæŒ‰é’®æ¥åˆ›å»ºæž¶æž„å›¾è¡¨"
                           FontSize="14"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           MaxWidth="300" />
              </StackPanel>
            </Border>

            <!-- WebView å®¹å™¨ (å°†åœ¨ä»£ç åŽç«¯å®žçŽ°) -->
            <Border IsVisible="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}"
                    Background="White"
                    CornerRadius="8"
                    x:Name="DiagramContainer">
              <WebView x:Name="DiagramWebView" />
            </Border>
          </Grid>
        </Border>
      </Grid>
    </Grid>
  </Grid>

  <!-- æ ·å¼å®šä¹‰ -->
  <UserControl.Styles>
    <Style Selector="Button.toolbar">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseLowBrush}" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="8" />
      <Setter Property="MinWidth" Value="36" />
      <Setter Property="MinHeight" Value="36" />
    </Style>
    
    <Style Selector="Button.toolbar:pointerover">
      <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundListLowBrush}" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" />
    </Style>
    
    <Style Selector="Button.toolbar:pressed">
      <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundListMediumBrush}" />
    </Style>
  </UserControl.Styles>

</UserControl>