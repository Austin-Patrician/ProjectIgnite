<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ProjectIgnite.ViewModels"
             xmlns:converters="using:ProjectIgnite.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="ProjectIgnite.Views.ProjectStructureView"
             x:DataType="vm:ProjectStructureViewModel">

  <Design.DataContext>
    <vm:ProjectStructureViewModel />
  </Design.DataContext>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- 标题栏 -->
    <Border Grid.Row="0" 
            Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
            BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
            BorderThickness="0,0,0,1"
            Padding="24,16">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!-- 标题和描述 -->
        <StackPanel Grid.Column="0" Orientation="Vertical">
          <TextBlock Text="{Binding Title}"
                     FontSize="20"
                     FontWeight="SemiBold"
                     Margin="0,0,0,4" />
          <TextBlock Text="{Binding Description}"
                     FontSize="14"
                     Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
        </StackPanel>

        <!-- 工具栏按钮 -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
          <!-- 模式切换按钮 -->
          <ToggleButton IsChecked="{Binding IsDiagramMode}"
                        Command="{Binding ToggleModeCommand}"
                        ToolTip.Tip="切换到图表模式"
                        Classes="mode-toggle">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="{Binding IsDiagramMode, Converter={x:Static converters:BooleanToStringConverter.Instance}, ConverterParameter='📊|🏗️'}" FontSize="16" />
              <TextBlock Text="{Binding IsDiagramMode, Converter={x:Static converters:BooleanToStringConverter.Instance}, ConverterParameter='图表|结构'}" FontSize="12" />
            </StackPanel>
          </ToggleButton>
          
          <!-- 结构模式按钮 -->
          <StackPanel Orientation="Horizontal" Spacing="4" IsVisible="{Binding !IsDiagramMode}">
            <Button Command="{Binding RefreshCommand}"
                    ToolTip.Tip="刷新项目结构"
                    Classes="toolbar">
              <TextBlock Text="🔄" FontSize="16" />
            </Button>
            <Button Command="{Binding ExpandAllCommand}"
                    ToolTip.Tip="展开所有节点"
                    Classes="toolbar">
              <TextBlock Text="📂" FontSize="16" />
            </Button>
            <Button Command="{Binding CollapseAllCommand}"
                    ToolTip.Tip="折叠所有节点"
                    Classes="toolbar">
              <TextBlock Text="📁" FontSize="16" />
            </Button>
          </StackPanel>
          
          <!-- 图表模式按钮 -->
          <StackPanel Orientation="Horizontal" Spacing="4" IsVisible="{Binding IsDiagramMode}">
            <Button Command="{Binding GenerateDiagramCommand}"
                    ToolTip.Tip="生成图表"
                    Classes="toolbar primary"
                    IsEnabled="{Binding !IsGenerating}">
              <TextBlock Text="✨" FontSize="16" />
            </Button>
            <Button Command="{Binding CancelGenerationCommand}"
                    ToolTip.Tip="取消生成"
                    Classes="toolbar"
                    IsVisible="{Binding IsGenerating}">
              <TextBlock Text="⏹️" FontSize="16" />
            </Button>
            <Button Command="{Binding ExportDiagramCommand}"
                    ToolTip.Tip="导出图表"
                    Classes="toolbar"
                    IsEnabled="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}">
              <TextBlock Text="💾" FontSize="16" />
            </Button>
            <Button Command="{Binding ClearDiagramCommand}"
                    ToolTip.Tip="清除图表"
                    Classes="toolbar"
                    IsEnabled="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}">
              <TextBlock Text="🗑️" FontSize="16" />
            </Button>
          </StackPanel>
        </StackPanel>
      </Grid>
    </Border>

    <!-- 主内容区域 -->
    <Grid Grid.Row="1">
      <!-- 结构模式 -->
      <Grid IsVisible="{Binding !IsDiagramMode}">
        <!-- 加载状态 -->
        <Border IsVisible="{Binding IsLoading}"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                CornerRadius="8"
                Padding="24">
          <StackPanel Orientation="Horizontal" Spacing="12">
            <Border Width="20" Height="20"
                    Background="{DynamicResource SystemControlForegroundAccentBrush}"
                    CornerRadius="10">
              <Border.RenderTransform>
                <RotateTransform />
              </Border.RenderTransform>
              <Border.Styles>
                <Style Selector="Border">
                  <Style.Animations>
                    <Animation Duration="0:0:1" IterationCount="INFINITE">
                      <KeyFrame Cue="0%">
                        <Setter Property="RenderTransform">
                          <RotateTransform Angle="0" />
                        </Setter>
                      </KeyFrame>
                      <KeyFrame Cue="100%">
                        <Setter Property="RenderTransform">
                          <RotateTransform Angle="360" />
                        </Setter>
                      </KeyFrame>
                    </Animation>
                  </Style.Animations>
                </Style>
              </Border.Styles>
            </Border>
            <TextBlock Text="正在加载项目结构..."
                       FontSize="14"
                       VerticalAlignment="Center" />
          </StackPanel>
        </Border>

        <!-- 空状态 -->
        <Border IsVisible="{Binding !IsLoading}"
                Background="Transparent"
                Padding="24">
          <ScrollViewer>
            <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                    CornerRadius="8"
                    Padding="48"
                    MinHeight="400">
              <StackPanel HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Spacing="16">
                <!-- 图标 -->
                <TextBlock Text="🏗️"
                           FontSize="64"
                           HorizontalAlignment="Center"
                           Opacity="0.6" />
                
                <!-- 标题 -->
                <TextBlock Text="项目结构"
                           FontSize="24"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,8" />
                
                <!-- 描述 -->
                <TextBlock Text="{Binding EmptyStateMessage}"
                           FontSize="16"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           HorizontalAlignment="Center"
                           TextWrapping="Wrap"
                           MaxWidth="400"
                           TextAlignment="Center" />
                
                <!-- 占位内容 -->
                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                        CornerRadius="6"
                        Padding="16"
                        Margin="0,16,0,0"
                        MaxWidth="500">
                  <StackPanel Spacing="8">
                    <TextBlock Text="功能规划："
                               FontWeight="SemiBold"
                               FontSize="14" />
                    <TextBlock Text="• 显示项目文件树结构"
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="• 支持文件夹展开/折叠"
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="• 显示文件类型和大小信息"
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="• 支持搜索和过滤功能"
                               FontSize="13"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                  </StackPanel>
                </Border>
              </StackPanel>
            </Border>
          </ScrollViewer>
        </Border>
      </Grid>

      <!-- 图表模式 -->
      <Grid IsVisible="{Binding IsDiagramMode}">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="350" />
          <ColumnDefinition Width="4" />
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- 左侧控制面板 -->
        <Border Grid.Column="0"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="0,0,1,0"
                Padding="16">
          <ScrollViewer>
            <StackPanel Spacing="16">
              <!-- 仓库URL输入 -->
              <StackPanel Spacing="8">
                <TextBlock Text="GitHub 仓库 URL"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <TextBox Text="{Binding RepositoryUrl}"
                         Watermark="https://github.com/owner/repo"
                         Classes="modern" />
              </StackPanel>

              <!-- 自定义指令 -->
              <StackPanel Spacing="8">
                <TextBlock Text="自定义指令（可选）"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <TextBox Text="{Binding CustomInstructions}"
                         Watermark="例如：重点关注数据流，忽略测试文件"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MinHeight="80"
                         Classes="modern" />
              </StackPanel>

              <!-- 生成进度 -->
              <StackPanel Spacing="8" IsVisible="{Binding IsGenerating}">
                <TextBlock Text="生成进度"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <ProgressBar Value="{Binding GenerationProgress.Percentage}"
                             Maximum="100"
                             Height="6"
                             CornerRadius="3" />
                <TextBlock Text="{Binding GenerationProgress.Message}"
                           FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
              </StackPanel>

              <!-- 仓库信息 -->
              <StackPanel Spacing="8" IsVisible="{Binding RepositoryInfo, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}">
                <TextBlock Text="仓库信息"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                        CornerRadius="6"
                        Padding="12">
                  <StackPanel Spacing="6">
                    <TextBlock Text="{Binding RepositoryInfo.Name}"
                               FontWeight="SemiBold"
                               FontSize="13" />
                    <TextBlock Text="{Binding RepositoryInfo.Description}"
                               FontSize="12"
                               TextWrapping="Wrap"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBlock Text="{Binding RepositoryInfo.Language}"
                                 FontSize="11"
                                 Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                      <TextBlock Text="{Binding RepositoryInfo.StarCount, StringFormat='⭐ {0}'}"
                                 FontSize="11"
                                 Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>
                  </StackPanel>
                </Border>
              </StackPanel>

              <!-- 图表操作 -->
              <StackPanel Spacing="8" IsVisible="{Binding ShowDiagramControls}">
                <TextBlock Text="图表操作"
                           FontWeight="SemiBold"
                           FontSize="14" />
                <TextBox Text="{Binding ModificationInstructions}"
                         Watermark="输入修改指令..."
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MinHeight="60"
                         Classes="modern" />
                <Button Command="{Binding ModifyDiagramCommand}"
                        Content="修改图表"
                        Classes="modern primary"
                        HorizontalAlignment="Stretch" />
                <Button Command="{Binding CopyDiagramCodeCommand}"
                        Content="复制代码"
                        Classes="modern"
                        HorizontalAlignment="Stretch" />
              </StackPanel>
            </StackPanel>
          </ScrollViewer>
        </Border>

        <!-- 分隔符 -->
        <GridSplitter Grid.Column="1"
                      Background="{DynamicResource SystemControlForegroundBaseLowBrush}"
                      ResizeDirection="Columns" />

        <!-- 右侧图表显示区域 -->
        <Border Grid.Column="2"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                Padding="16">
          <!-- 图表内容 -->
          <Grid>
            <!-- 空状态 -->
            <Border IsVisible="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}, ConverterParameter=Invert}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
              <StackPanel Spacing="16" HorizontalAlignment="Center">
                <TextBlock Text="📊"
                           FontSize="64"
                           HorizontalAlignment="Center"
                           Opacity="0.6" />
                <TextBlock Text="架构图表"
                           FontSize="24"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Center" />
                <TextBlock Text="输入 GitHub 仓库 URL 并点击生成按钮来创建架构图表"
                           FontSize="14"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           MaxWidth="300" />
              </StackPanel>
            </Border>

            <!-- WebView 容器 (将在代码后端实现) -->
            <Border IsVisible="{Binding CurrentDiagram, Converter={x:Static converters:ObjectToBooleanConverter.Instance}}"
                    Background="White"
                    CornerRadius="8"
                    x:Name="DiagramContainer">
              <WebView x:Name="DiagramWebView" />
            </Border>
          </Grid>
        </Border>
      </Grid>
    </Grid>
  </Grid>

  <!-- 样式定义 -->
  <UserControl.Styles>
    <Style Selector="Button.toolbar">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseLowBrush}" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="8" />
      <Setter Property="MinWidth" Value="36" />
      <Setter Property="MinHeight" Value="36" />
    </Style>
    
    <Style Selector="Button.toolbar:pointerover">
      <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundListLowBrush}" />
      <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" />
    </Style>
    
    <Style Selector="Button.toolbar:pressed">
      <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundListMediumBrush}" />
    </Style>
  </UserControl.Styles>

</UserControl>